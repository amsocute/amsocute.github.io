<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ระบบรายได้ตู้</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap');
    
    body {
      font-family: 'Noto Sans Thai', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e9f2 100%);
    }
    
    .glass-effect {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }
    
    .btn-primary {
      background: linear-gradient(45deg, #ff6b2c, #ff8e53);
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 7px 14px rgba(255, 107, 44, 0.3);
    }
    
    .btn-success {
      background: linear-gradient(45deg, #56ab2f, #a8e6cf);
      transition: all 0.3s ease;
    }
    
    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 7px 14px rgba(86, 171, 47, 0.3);
    }
    
    .btn-danger {
      background: linear-gradient(45deg, #ff416c, #ff4b2b);
      transition: all 0.3s ease;
    }
    
    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 7px 14px rgba(255, 65, 108, 0.3);
    }
    
    .btn-info {
      background: linear-gradient(45deg, #2196F3, #21CBF3);
      transition: all 0.3s ease;
    }
    
    .btn-info:hover {
      transform: translateY(-2px);
      box-shadow: 0 7px 14px rgba(33, 150, 243, 0.3);
    }
    
    .btn-calculate {
      background: linear-gradient(45deg, #9c27b0, #e040fb);
      transition: all 0.3s ease;
    }
    
    .btn-calculate:hover {
      transform: translateY(-2px);
      box-shadow: 0 7px 14px rgba(156, 39, 176, 0.3);
    }
    
    .btn-send {
      background: linear-gradient(45deg, #00b09b, #96c93d);
      transition: all 0.3s ease;
    }
    
    .btn-send:hover {
      transform: translateY(-2px);
      box-shadow: 0 7px 14px rgba(0, 176, 155, 0.3);
    }
    
    .income-input {
      transition: all 0.3s ease;
    }
    
    .income-input:focus {
      transform: scale(1.02);
      box-shadow: 0 0 0 3px rgba(255, 107, 44, 0.2);
    }
    
    .card {
      transition: all 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    
    .table-row {
      transition: all 0.2s ease;
    }
    
    .table-row:hover {
      background-color: rgba(255, 107, 44, 0.05);
    }
    
    .summary-card {
      background: linear-gradient(135deg, #ff6b2c 0%, #ff8e53 100%);
      color: white;
      transition: all 0.3s ease;
    }
    
    .summary-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(255, 107, 44, 0.3);
    }
    
    .expense-card {
      background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
      color: white;
      transition: all 0.3s ease;
    }
    
    .expense-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(86, 171, 47, 0.3);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease forwards;
    }
    
    .pulse {
      animation: pulse 1s infinite;
    }
    
    .btn-icon {
      transition: all 0.2s ease;
    }
    
    .btn-icon:hover {
      transform: scale(1.1);
    }
    
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
      animation: fadeIn 0.3s ease;
    }
    
    .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 0;
      border-radius: 20px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideIn 0.4s ease;
      overflow: hidden;
    }
    
    @keyframes slideIn {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .modal-header {
      background: linear-gradient(45deg, #ff6b2c, #ff8e53);
      color: white;
      padding: 20px;
      text-align: center;
      position: relative;
    }
    
    .modal-header.reset {
      background: linear-gradient(45deg, #ff416c, #ff4b2b);
    }
    
    .modal-header.send {
      background: linear-gradient(45deg, #00b09b, #96c93d);
    }
    
    .modal-body {
      padding: 25px;
      text-align: center;
    }
    
    .modal-footer {
      padding: 15px 25px;
      text-align: center;
      background-color: #f8f9fa;
      border-top: 1px solid #e9ecef;
    }
    
    .close {
      position: absolute;
      right: 20px;
      top: 20px;
      color: white;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .close:hover {
      transform: rotate(90deg);
    }
    
    .summary-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }
    
    .summary-item:last-child {
      border-bottom: none;
      font-weight: bold;
      font-size: 1.2em;
      color: #ff6b2c;
    }
    
    .loading-spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top: 4px solid #00b09b;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* ปรับสำหรับมือถือ */
    @media (max-width: 768px) {
      .mobile-input {
        font-size: 16px; /* ป้องกันการ zoom เมื่อ focus บน iOS */
      }
      
      .mobile-table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      .mobile-button {
        padding: 12px 16px;
        font-size: 16px;
      }
      
      .mobile-card {
        padding: 16px;
      }
      
      .modal-content {
        margin: 20% auto;
        width: 95%;
      }
      
      /* ปรับขนาดช่องสาขาให้ใหญ่ขึ้นในมือถือ */
      .branch-input {
        min-width: 150px !important;
        font-size: 16px !important;
        padding: 8px !important;
      }
      
      /* ปรับขนาดตารางให้ใหญ่ขึ้นในมือถือ */
      .mobile-table {
        font-size: 14px !important;
      }
      
      .mobile-table td, .mobile-table th {
        padding: 8px 4px !important;
      }
      
      /* ปรับขนาดช่องรายได้ให้ใหญ่ขึ้นในมือถือ */
      .income-field {
        min-width: 100px !important;
        font-size: 16px !important;
      }
    }
  </style>
</head>
<body class="min-h-screen p-2 md:p-8">
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <header class="text-center mb-6 fade-in">
      <div class="inline-flex items-center justify-center bg-white rounded-full p-3 shadow-lg mb-3">
        <i class="fas fa-chart-line text-3xl text-[#ff6b2c]"></i>
      </div>
      <h1 class="text-3xl md:text-4xl font-bold text-[#ff6b2c] mb-2">ระบบรายได้ตู้</h1>
      <p class="text-gray-600 text-sm md:text-base">ระบบจัดการรายได้และค่าใช้จ่ายสำหรับตู้ขายของ</p>
    </header>

    <!-- Main Content -->
    <div class="grid grid-cols-1 gap-6 mb-6">
      <!-- Date Card -->
      <div class="glass-effect p-4 md:p-6 card fade-in mobile-card">
        <div class="flex items-center mb-3">
          <i class="fas fa-calendar-alt text-xl md:text-2xl text-[#ff6b2c] mr-3"></i>
          <h2 class="text-lg md:text-xl font-semibold text-gray-800">วันที่บันทึก</h2>
        </div>
        <div class="flex flex-col items-start gap-3">
          <input type="date" id="date" class="income-input mobile-input border-2 border-gray-200 rounded-xl p-3 w-full focus:outline-none focus:border-[#ff6b2c] text-lg">
          <div id="formattedDate" class="text-gray-600 bg-gray-100 px-4 py-2 rounded-lg font-medium w-full text-center"></div>
        </div>
      </div>

      <!-- Buttons -->
      <div class="glass-effect p-4 md:p-6 card fade-in mobile-card">
        <div class="grid grid-cols-2 gap-3">
          <button id="addBranch" class="btn-success text-white font-semibold py-3 px-4 rounded-xl shadow flex items-center justify-center mobile-button">
            <i class="fas fa-plus-circle mr-2"></i> <span>เพิ่มสาขา</span>
          </button>
          <button id="reset" class="btn-danger text-white font-semibold py-3 px-4 rounded-xl shadow flex items-center justify-center mobile-button">
            <i class="fas fa-redo-alt mr-2"></i> <span>รีเซ็ต</span>
          </button>
          <button id="exportCSV" class="btn-info text-white font-semibold py-3 px-4 rounded-xl shadow flex items-center justify-center mobile-button">
            <i class="fas fa-file-csv mr-2"></i> <span>ออกรายงาน</span>
          </button>
          <button id="calculate" class="btn-calculate text-white font-semibold py-3 px-4 rounded-xl shadow flex items-center justify-center mobile-button">
            <i class="fas fa-calculator mr-2"></i> <span>คำนวณ</span>
          </button>
          <button id="sendData" class="btn-send text-white font-semibold py-3 px-4 rounded-xl shadow flex items-center justify-center mobile-button">
            <i class="fas fa-paper-plane mr-2"></i> <span>ส่งข้อมูล</span>
          </button>
        </div>
      </div>

      <!-- Branches Table -->
      <div class="glass-effect p-4 md:p-6 card overflow-hidden fade-in mobile-card">
        <div class="flex items-center mb-4">
          <i class="fas fa-store text-xl md:text-2xl text-[#ff6b2c] mr-3"></i>
          <h2 class="text-lg md:text-xl font-semibold text-gray-800">ข้อมูลสาขา</h2>
        </div>
        <div class="mobile-table-container">
          <table class="w-full border-collapse mobile-table">
            <thead>
              <tr class="border-b-2 border-[#ff6b2c]/30 bg-[#ff6b2c]/10">
                <th class="py-2 px-2 md:px-4 text-left font-semibold text-gray-700 text-xs md:text-sm">
                  <i class="fas fa-building mr-1"></i><span class="hidden sm:inline">สาขา</span>
                </th>
                <th class="py-2 px-2 md:px-4 text-left font-semibold text-gray-700 text-xs md:text-sm">
                  <i class="fas fa-money-bill-wave mr-1"></i><span class="hidden sm:inline">รายได้</span>
                </th>
                <th class="py-2 px-2 md:px-4 text-left font-semibold text-gray-700 text-xs md:text-sm">
                  <i class="fas fa-percentage mr-1"></i><span class="hidden sm:inline">% เก็บ</span>
                </th>
                <th class="py-2 px-2 md:px-4 text-left font-semibold text-red-600 text-xs md:text-sm">
                  <i class="fas fa-hand-holding-usd mr-1"></i><span class="hidden sm:inline">ค่าใช้จ่าย</span>
                </th>
                <th class="py-2 px-2 md:px-4 text-left font-semibold text-green-600 text-xs md:text-sm">
                  <i class="fas fa-chart-line mr-1"></i><span class="hidden sm:inline">กำไร</span>
                </th>
                <th class="py-2 px-2 md:px-4 text-left font-semibold text-gray-700 text-xs md:text-sm">
                  <i class="fas fa-map-marker-alt mr-1"></i><span class="hidden sm:inline">โลเคชั่น</span>
                </th>
                <th class="py-2 px-2 md:px-4 text-center font-semibold text-gray-700 text-xs md:text-sm">
                  <i class="fas fa-trash-alt mr-1"></i><span class="hidden sm:inline">ลบ</span>
                </th>
              </tr>
            </thead>
            <tbody id="branchesBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Additional Expenses -->
      <div class="glass-effect p-4 md:p-6 card fade-in mobile-card">
        <div class="flex items-center mb-4">
          <i class="fas fa-shopping-cart text-xl md:text-2xl text-[#ff6b2c] mr-3"></i>
          <h2 class="text-lg md:text-xl font-semibold text-gray-800">ค่าใช้จ่ายเพิ่มเติม</h2>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block mb-2 font-medium text-gray-700 text-sm md:text-base">
              <i class="fas fa-calendar-day mr-2 text-[#ff6b2c]"></i>ค่าใช้จ่ายรายวัน
            </label>
            <div class="flex items-center">
              <button class="btn-icon bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded-l-lg border border-gray-300">
                <i class="fas fa-minus"></i>
              </button>
              <div class="relative flex-grow">
                <input type="number" id="daily" class="income-input mobile-input border-2 border-gray-200 w-full focus:outline-none focus:border-[#ff6b2c] text-right pr-10 py-2">
                <span class="absolute right-3 top-2 text-gray-500">฿</span>
              </div>
              <button class="btn-icon bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded-r-lg border border-gray-300">
                <i class="fas fa-plus"></i>
              </button>
            </div>
          </div>
          <div>
            <label class="block mb-2 font-medium text-gray-700 text-sm md:text-base">
              <i class="fas fa-gas-pump mr-2 text-[#ff6b2c]"></i>ค่าน้ำมัน
            </label>
            <div class="flex items-center">
              <button class="btn-icon bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded-l-lg border border-gray-300">
                <i class="fas fa-minus"></i>
              </button>
              <div class="relative flex-grow">
                <input type="number" id="fuel" class="income-input mobile-input border-2 border-gray-200 w-full focus:outline-none focus:border-[#ff6b2c] text-right pr-10 py-2">
                <span class="absolute right-3 top-2 text-gray-500">฿</span>
              </div>
              <button class="btn-icon bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded-r-lg border border-gray-300">
                <i class="fas fa-plus"></i>
              </button>
            </div>
          </div>
          <div>
            <label class="block mb-2 font-medium text-gray-700 text-sm md:text-base">
              <i class="fas fa-utensils mr-2 text-[#ff6b2c]"></i>ค่าอาหาร
            </label>
            <div class="flex items-center">
              <button class="btn-icon bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded-l-lg border border-gray-300">
                <i class="fas fa-minus"></i>
              </button>
              <div class="relative flex-grow">
                <input type="number" id="food" class="income-input mobile-input border-2 border-gray-200 w-full focus:outline-none focus:border-[#ff6b2c] text-right pr-10 py-2">
                <span class="absolute right-3 top-2 text-gray-500">฿</span>
              </div>
              <button class="btn-icon bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded-r-lg border border-gray-300">
                <i class="fas fa-plus"></i>
              </button>
            </div>
          </div>
          <div>
            <label class="block mb-2 font-medium text-gray-700 text-sm md:text-base">
              <i class="fas fa-box mr-2 text-[#ff6b2c]"></i>อื่น ๆ
            </label>
            <div class="flex items-center">
              <button class="btn-icon bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded-l-lg border border-gray-300">
                <i class="fas fa-minus"></i>
              </button>
              <div class="relative flex-grow">
                <input type="number" id="other" class="income-input mobile-input border-2 border-gray-200 w-full focus:outline-none focus:border-[#ff6b2c] text-right pr-10 py-2">
                <span class="absolute right-3 top-2 text-gray-500">฿</span>
              </div>
              <button class="btn-icon bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded-r-lg border border-gray-300">
                <i class="fas fa-plus"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Summary Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="summary-card p-4 md:p-6 rounded-xl shadow-lg card fade-in mobile-card">
          <div class="flex items-center mb-4">
            <i class="fas fa-chart-pie text-xl md:text-2xl mr-3"></i>
            <h2 class="text-lg md:text-xl font-semibold">สรุปรายได้</h2>
          </div>
          <div id="summary1" class="space-y-3"></div>
        </div>
        
        <div class="expense-card p-4 md:p-6 rounded-xl shadow-lg card fade-in mobile-card">
          <div class="flex items-center mb-4">
            <i class="fas fa-wallet text-xl md:text-2xl mr-3"></i>
            <h2 class="text-lg md:text-xl font-semibold">สรุปค่าใช้จ่าย</h2>
          </div>
          <div id="summary2" class="space-y-3"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Calculate Modal -->
  <div id="calculateModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span class="close" onclick="closeModal('calculateModal')">&times;</span>
        <h2><i class="fas fa-calculator mr-2"></i>ผลการคำนวณ</h2>
      </div>
      <div class="modal-body">
        <div class="mb-4">
          <i class="fas fa-check-circle text-5xl text-green-500 mb-3"></i>
          <p class="text-lg">คำนวณเสร็จสิ้น!</p>
        </div>
        <div id="modalSummary" class="text-left bg-gray-50 p-4 rounded-lg">
          <!-- สรุปผลการคำนวณจะแสดงที่นี่ -->
        </div>
      </div>
      <div class="modal-footer">
        <button onclick="closeModal('calculateModal')" class="btn-calculate text-white font-semibold py-2 px-6 rounded-lg">
          ตกลง
        </button>
      </div>
    </div>
  </div>

  <!-- Reset Modal -->
  <div id="resetModal" class="modal">
    <div class="modal-content">
      <div class="modal-header reset">
        <span class="close" onclick="closeModal('resetModal')">&times;</span>
        <h2><i class="fas fa-exclamation-triangle mr-2"></i>ยืนยันการรีเซ็ต</h2>
      </div>
      <div class="modal-body">
        <div class="mb-4">
          <i class="fas fa-question-circle text-5xl text-yellow-500 mb-3"></i>
          <p class="text-lg">คุณแน่ใจหรือไม่ว่าต้องการรีเซ็ตข้อมูลทั้งหมด?</p>
          <p class="text-gray-600">การดำเนินการนี้ไม่สามารถย้อนกลับได้</p>
        </div>
      </div>
      <div class="modal-footer">
        <button onclick="closeModal('resetModal')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-6 rounded-lg mr-3">
          ยกเลิก
        </button>
        <button onclick="confirmReset()" class="btn-danger text-white font-semibold py-2 px-6 rounded-lg">
          ยืนยันการรีเซ็ต
        </button>
      </div>
    </div>
  </div>

  <!-- Send Data Modal -->
  <div id="sendDataModal" class="modal">
    <div class="modal-content">
      <div class="modal-header send">
        <span class="close" onclick="closeModal('sendDataModal')">&times;</span>
        <h2><i class="fas fa-paper-plane mr-2"></i>ส่งข้อมูลไปยัง Google Sheet</h2>
      </div>
      <div class="modal-body">
        <div id="sendStatus" class="mb-4">
          <!-- สถานะการส่งข้อมูลจะแสดงที่นี่ -->
        </div>
        <div id="modalSendSummary" class="text-left bg-gray-50 p-4 rounded-lg">
          <!-- สรุปข้อมูลที่จะส่งจะแสดงที่นี่ -->
        </div>
      </div>
      <div class="modal-footer">
        <button onclick="closeModal('sendDataModal')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-6 rounded-lg mr-3">
          ปิด
        </button>
        <button id="confirmSend" class="btn-send text-white font-semibold py-2 px-6 rounded-lg">
          ยืนยันการส่ง
        </button>
      </div>
    </div>
  </div>

  <!-- Audio elements for sound effects -->
  <audio id="calculateSound" preload="auto">
    <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmFgU7k9n1unEiBC13yO/eizEIHWq+8+OWT" type="audio/wav">
  </audio>
  <audio id="resetSound" preload="auto">
    <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmFgU7k9n1unEiBC13yO/eizEIHWq+8+OWT" type="audio/wav">
  </audio>
  <audio id="sendSound" preload="auto">
    <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmFgU7k9n1unEiBC13yO/eizEIHWq+8+OWT" type="audio/wav">
  </audio>

<script>
const INITIAL_BRANCHES = 10;
let branches = Array.from({length: INITIAL_BRANCHES}, (_, i)=>({name:`สาขา ${i+1}`, income:0, percent:30, location:""}));

const monthsTH = ["มกราคม","กุมภาพันธ์","มีนาคม","เมษายน","พฤษภาคม","มิถุนายน",
                  "กรกฎาคม","สิงหาคม","กันยายน","ตุลาคม","พฤศจิกายน","ธันวาคม"];

function formatThaiDate(dateStr){
  if(!dateStr) return "";
  const [year,month,day]=dateStr.split("-").map(Number);
  return `${day} ${monthsTH[month-1]} ${year+543}`;
}

function renderTable(){
  const tbody = document.getElementById("branchesBody");
  tbody.innerHTML="";
  branches.forEach((b,i)=>{
    const cost = (b.income*b.percent)/100;
    const profit = b.income-cost;
    const tr = document.createElement("tr");
    tr.className="border-b table-row";
    tr.innerHTML=`
      <td class="py-2 px-2 md:px-4">
        <input type="text" value="${b.name}" class="w-full border-2 border-gray-200 rounded-lg p-1 md:p-2 text-xs md:text-sm focus:border-[#ff6b2c] focus:outline-none transition-all mobile-input branch-input">
      </td>
      <td class="py-2 px-2 md:px-4">
        <div class="flex items-center">
          <button class="btn-icon bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded-l-lg border border-gray-300 text-xs income-minus">
            <i class="fas fa-minus"></i>
          </button>
          <div class="relative">
            <input type="text" value="${b.income}" class="w-16 md:w-24 text-center border-t-2 border-b-2 border-gray-300 focus:outline-none py-1 mobile-input income-input income-field" maxlength="5">
            <span class="absolute right-1 md:right-2 top-1 text-gray-500 text-xs">฿</span>
          </div>
          <button class="btn-icon bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded-r-lg border border-gray-300 text-xs income-plus">
            <i class="fas fa-plus"></i>
          </button>
        </div>
      </td>
      <td class="py-2 px-2 md:px-4">
        <div class="flex items-center justify-center">
          <button class="btn-icon bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded-l-lg border border-gray-300 text-xs percent-minus">
            <i class="fas fa-minus"></i>
          </button>
          <input type="text" value="${b.percent}" class="w-8 md:w-12 text-center border-t-2 border-b-2 border-gray-300 focus:outline-none py-1 mobile-input percent-input">
          <button class="btn-icon bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded-r-lg border border-gray-300 text-xs percent-plus">
            <i class="fas fa-plus"></i>
          </button>
        </div>
      </td>
      <td class="py-2 px-2 md:px-4 text-red-500 font-bold text-right text-xs md:text-sm">
        <i class="fas fa-arrow-down mr-1"></i>${cost.toLocaleString()}
      </td>
      <td class="py-2 px-2 md:px-4 text-green-600 font-bold text-right text-xs md:text-sm">
        <i class="fas fa-arrow-up mr-1"></i>${profit.toLocaleString()}
      </td>
      <td class="py-2 px-2 md:px-4">
        <input type="text" value="${b.location}" class="w-full border-2 border-gray-200 rounded-lg p-1 md:p-2 text-xs md:text-sm focus:border-[#ff6b2c] focus:outline-none transition-all mobile-input">
      </td>
      <td class="py-2 px-2 md:px-4 text-center">
        <button class="btn-icon bg-red-500 hover:bg-red-600 text-white py-1 px-2 rounded-lg text-xs">
          <i class="fas fa-trash"></i>
        </button>
      </td>
    `;
    tbody.appendChild(tr);

    // สาขา
    tr.children[0].querySelector("input").addEventListener("input",(e)=>{b.name=e.target.value});

    // รายได้
    const incomeInput = tr.children[1].querySelector("input");
    incomeInput.addEventListener("input",(e)=>{
      // จำกัดค่าไม่เกิน 5 หลัก
      let value = e.target.value;
      if (value.length > 5) {
        value = value.substring(0, 5);
        e.target.value = value;
      }
      b.income=parseInt(value)||0;
      updateRowValues(tr, b);
      renderSummary();
    });
    
    tr.querySelector(".income-minus").addEventListener("click",()=>{
      b.income-=100; 
      if(b.income<0)b.income=0; 
      incomeInput.value = b.income;
      updateRowValues(tr, b);
      renderSummary();
    });
    
    tr.querySelector(".income-plus").addEventListener("click",()=>{
      // ตรวจสอบว่าเพิ่มแล้วจะเกิน 5 หลักหรือไม่
      if (b.income < 99900) {
        b.income+=100; 
        if(b.income>99999)b.income=99999; // จำกัดค่าสูงสุด
        incomeInput.value = b.income;
        updateRowValues(tr, b);
        renderSummary();
      }
    });

    // เปอร์เซ็นต์
    const percInput = tr.children[2].querySelector("input");
    percInput.addEventListener("input",(e)=>{
      b.percent=parseInt(e.target.value)||30; 
      if(b.percent<30)b.percent=30;
      if(b.percent>50)b.percent=50;
      percInput.value = b.percent;
      updateRowValues(tr, b);
      renderSummary();
    });
    
    tr.querySelector(".percent-minus").addEventListener("click",()=>{
      b.percent-=5;
      if(b.percent<30)b.percent=30; 
      percInput.value = b.percent;
      updateRowValues(tr, b);
      renderSummary();
    });
    
    tr.querySelector(".percent-plus").addEventListener("click",()=>{
      b.percent+=5;
      if(b.percent>50)b.percent=50; 
      percInput.value = b.percent;
      updateRowValues(tr, b);
      renderSummary();
    });

    // โลเคชั่น
    tr.children[5].querySelector("input").addEventListener("input",(e)=>{b.location=e.target.value});

    // ลบ
    tr.children[6].querySelector("button").addEventListener("click",()=>{
      branches.splice(i,1);
      renderTable();
    });
  });
}

function updateRowValues(tr, branch) {
  const cost = (branch.income * branch.percent) / 100;
  const profit = branch.income - cost;
  
  tr.children[3].innerHTML = `<i class="fas fa-arrow-down mr-1"></i>${cost.toLocaleString()}`;
  tr.children[4].innerHTML = `<i class="fas fa-arrow-up mr-1"></i>${profit.toLocaleString()}`;
}

function getExpenses(){
  return {
    daily:parseInt(document.getElementById("daily").value)||0,
    fuel:parseInt(document.getElementById("fuel").value)||0,
    food:parseInt(document.getElementById("food").value)||0,
    other:parseInt(document.getElementById("other").value)||0
  };
}

function renderSummary(){
  const totalIncome = branches.reduce((a,b)=>a+b.income,0);
  const totalBranchCost = branches.reduce((a,b)=>a+(b.income*b.percent/100),0);
  const totalBranchProfit = totalIncome-totalBranchCost;
  const expenses = getExpenses();
  const totalExpenses = expenses.daily+expenses.fuel+expenses.food+expenses.other;
  const finalProfit = totalBranchProfit-totalExpenses;
  const avgPercent = branches.length?branches.reduce((a,b)=>a+b.percent,0)/branches.length:0;

  document.getElementById("summary1").innerHTML=`
    <div class="flex justify-between items-center">
      <span class="font-medium text-sm md:text-base">รวมรายได้:</span>
      <span class="font-bold text-lg md:text-xl">${totalIncome.toLocaleString()} ฿</span>
    </div>
    <div class="flex justify-between items-center">
      <span class="font-medium text-sm md:text-base">ค่าใช้จ่ายสาขา (${avgPercent.toFixed(0)}%):</span>
      <span class="font-bold text-lg md:text-xl">${totalBranchCost.toLocaleString()} ฿</span>
    </div>
    <div class="flex justify-between items-center border-t border-white/30 pt-3">
      <span class="font-medium text-sm md:text-base">กำไรสาขา:</span>
      <span class="font-bold text-lg md:text-xl">${totalBranchProfit.toLocaleString()} ฿</span>
    </div>
  `;
  document.getElementById("summary2").innerHTML=`
    <div class="flex justify-between items-center">
      <span class="font-medium text-sm md:text-base">ค่าใช้จ่ายเพิ่มเติม:</span>
      <span class="font-bold text-lg md:text-xl">${totalExpenses.toLocaleString()} ฿</span>
    </div>
    <div class="flex justify-between items-center border-t border-white/30 pt-3">
      <span class="font-medium text-sm md:text-base">กำไรสุทธิ:</span>
      <span class="font-bold text-xl md:text-2xl">${finalProfit.toLocaleString()} ฿</span>
    </div>
  `;
}

// Modal Functions
function openModal(modalId) {
  document.getElementById(modalId).style.display = "block";
  
  // เล่นเสียงตามประเภทของ modal
  if (modalId === 'calculateModal') {
    playSound('calculateSound');
  } else if (modalId === 'resetModal') {
    playSound('resetSound');
  } else if (modalId === 'sendDataModal') {
    playSound('sendSound');
  }
}

function closeModal(modalId) {
  document.getElementById(modalId).style.display = "none";
}

// Function to play sound
function playSound(soundId) {
  const sound = document.getElementById(soundId);
  if (sound) {
    sound.currentTime = 0; // Reset audio to beginning
    sound.play().catch(e => console.log("Audio play failed:", e));
  }
}

// ปุ่ม
document.getElementById("addBranch").addEventListener("click",()=>{
  branches.push({name:`สาขา ${branches.length+1}`, income:0, percent:30, location:""});
  renderTable();
});

document.getElementById("reset").addEventListener("click",()=>{
  openModal('resetModal');
});

function confirmReset() {
  branches=Array.from({length:INITIAL_BRANCHES}, (_,i)=>({name:`สาขา ${i+1}`, income:0, percent:30, location:""}));
  document.getElementById("daily").value="";
  document.getElementById("fuel").value="";
  document.getElementById("food").value="";
  document.getElementById("other").value="";
  document.getElementById("date").value="";
  document.getElementById("formattedDate").textContent="";
  document.getElementById("summary1").innerHTML = "";
  document.getElementById("summary2").innerHTML = "";
  renderTable();
  closeModal('resetModal');
}

document.getElementById("exportCSV").addEventListener("click",()=>{
  const header=["วันที่","สาขา","รายได้ (บาท)","% เก็บ","ค่าใช้จ่าย (บาท)","กำไร (บาท)","โลเคชั่น"];
  const date = document.getElementById("date").value;
  const dateRow=[formatThaiDate(date),"","","","","",""];
  const rows = branches.map(b=>["",b.name,b.income,b.percent,(b.income*b.percent/100),(b.income-(b.income*b.percent/100)),b.location]);
  const expenses=getExpenses();
  const summary=[
    ["","รวมรายได้", branches.reduce((a,b)=>a+b.income,0)],
    ["","ค่าใช้จ่ายสาขา", branches.reduce((a,b)=>a+(b.income*b.percent/100),0)],
    ["","กำไรสาขา", branches.reduce((a,b)=>a+b.income-(b.income*b.percent/100),0)],
    ["","ค่าใช้จ่ายเพิ่มเติม", expenses.daily+expenses.fuel+expenses.food+expenses.other],
    ["","กำไรสุทธิ",(branches.reduce((a,b)=>a+b.income-(b.income*b.percent/100),0)-(expenses.daily+expenses.fuel+expenses.food+expenses.other))]
  ];
  const csvContent="\uFEFF"+[header,dateRow,...rows,[],...summary].map(r=>r.join(",")).join("\n");
  const blob=new Blob([csvContent], {type:"text/csv;charset=utf-8;"});
  const link=document.createElement("a");
  link.href=URL.createObjectURL(blob);
  link.setAttribute("download",`รายงาน_${date||"ไม่ระบุวันที่"}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
});

// ปุ่มคำนวณ
document.getElementById("calculate").addEventListener("click",()=>{
  renderSummary();
  
  // แสดงการ์ดสรุปผลลัพธ์ด้วย animation
  const summaryCards = document.querySelectorAll('.summary-card, .expense-card');
  summaryCards.forEach((card, index) => {
    setTimeout(() => {
      card.style.animation = 'fadeIn 0.5s ease forwards';
    }, index * 200);
  });
  
  // แสดง modal พร้อมสรุปผลการคำนวณ
  showCalculateModal();
});

function showCalculateModal() {
  const totalIncome = branches.reduce((a,b)=>a+b.income,0);
  const totalBranchCost = branches.reduce((a,b)=>a+(b.income*b.percent/100),0);
  const totalBranchProfit = totalIncome-totalBranchCost;
  const expenses = getExpenses();
  const totalExpenses = expenses.daily+expenses.fuel+expenses.food+expenses.other;
  const finalProfit = totalBranchProfit-totalExpenses;
  const avgPercent = branches.length?branches.reduce((a,b)=>a+b.percent,0)/branches.length:0;
  
  document.getElementById("modalSummary").innerHTML = `
    <div class="summary-item">
      <span>รวมรายได้:</span>
      <span class="font-bold">${totalIncome.toLocaleString()} ฿</span>
    </div>
    <div class="summary-item">
      <span>ค่าใช้จ่ายสาขา (${avgPercent.toFixed(0)}%):</span>
      <span class="font-bold">${totalBranchCost.toLocaleString()} ฿</span>
    </div>
    <div class="summary-item">
      <span>กำไรสาขา:</span>
      <span class="font-bold">${totalBranchProfit.toLocaleString()} ฿</span>
    </div>
    <div class="summary-item">
      <span>ค่าใช้จ่ายเพิ่มเติม:</span>
      <span class="font-bold">${totalExpenses.toLocaleString()} ฿</span>
    </div>
    <div class="summary-item">
      <span>กำไรสุทธิ:</span>
      <span class="font-bold text-lg">${finalProfit.toLocaleString()} ฿</span>
    </div>
  `;
  
  openModal('calculateModal');
}

// ฟังก์ชันส่งข้อมูลไปยัง Google Sheet
function sendData() {
  // วันที่
  const date = document.getElementById("date").value;
  const formattedDate = formatThaiDate(date);

  // ตรวจสอบว่ากรอกวันที่หรือไม่
  if (!date) {
    alert("กรุณาเลือกวันที่ก่อนส่งข้อมูล");
    return;
  }

  // ค่าใช้จ่ายเพิ่มเติม
  const expenses = {
    daily: parseInt(document.getElementById("daily").value) || 0,
    fuel: parseInt(document.getElementById("fuel").value) || 0,
    food: parseInt(document.getElementById("food").value) || 0,
    other: parseInt(document.getElementById("other").value) || 0,
  };

  // รายละเอียดสาขา
  const rows = branches.map(b => ({
    name: b.name,
    income: b.income,
    percent: b.percent,
    location: b.location || "",
  }));

  // คำนวณค่ารวม
  const totalIncome = branches.reduce((a, b) => a + b.income, 0);
  const totalBranchCost = branches.reduce((a, b) => a + (b.income * b.percent / 100), 0);
  const totalBranchProfit = totalIncome - totalBranchCost;
  const totalExpenses = expenses.daily + expenses.fuel + expenses.food + expenses.other;
  const finalProfit = totalBranchProfit - totalExpenses;

  // รวมข้อมูลทั้งหมด
  const payload = {
    date: formattedDate,
    rows: rows,
    expenses: expenses,
    totals: {
      totalIncome: totalIncome,
      totalBranchCost: totalBranchCost,
      totalBranchProfit: totalBranchProfit,
      totalExpenses: totalExpenses,
      finalProfit: finalProfit
    }
  };

  console.log("📤 ส่งข้อมูล:", payload);

  // สร้าง FormData สำหรับส่งแบบ form-urlencoded (แก้ปัญหา CORS)
  const formData = new FormData();
  formData.append('date', formattedDate);
  formData.append('rows', JSON.stringify(rows));
  formData.append('expenses', JSON.stringify(expenses));
  formData.append('totals', JSON.stringify(payload.totals));

  // แสดง Modal ยืนยันการส่งข้อมูล
  showSendDataModal(payload);
}

// ฟังก์ชันแสดง Modal ยืนยันการส่งข้อมูล
function showSendDataModal(payload) {
  document.getElementById("modalSendSummary").innerHTML = `
    <div class="summary-item">
      <span>วันที่:</span>
      <span class="font-bold">${payload.date}</span>
    </div>
    <div class="summary-item">
      <span>จำนวนสาขา:</span>
      <span class="font-bold">${payload.rows.length} สาขา</span>
    </div>
    <div class="summary-item">
      <span>รวมรายได้:</span>
      <span class="font-bold">${payload.totals.totalIncome.toLocaleString()} ฿</span>
    </div>
    <div class="summary-item">
      <span>กำไรสุทธิ:</span>
      <span class="font-bold">${payload.totals.finalProfit.toLocaleString()} ฿</span>
    </div>
  `;
  
  // ตั้งค่าปุ่มยืนยันการส่ง
  document.getElementById("confirmSend").onclick = function() {
    // แสดงสถานะกำลังส่งข้อมูล
    document.getElementById("sendStatus").innerHTML = `
      <div class="loading-spinner"></div>
      <p class="text-lg">กำลังส่งข้อมูล...</p>
    `;
    
    // ส่งข้อมูลไปยัง Google Script
    const formData = new FormData();
    formData.append('date', payload.date);
    formData.append('rows', JSON.stringify(payload.rows));
    formData.append('expenses', JSON.stringify(payload.expenses));
    formData.append('totals', JSON.stringify(payload.totals));
    
    // URL ของ Google Apps Script Web App
    const url = "https://script.google.com/macros/s/AKfycbzF3PapFjrKOwAEUt1rRyq9-Z8_CIhhK_1w7NW0DpywScauv42i22-qVXIGC29u2A98/exec";
    
    fetch(url, {
      method: "POST",
      body: formData,
      // ลบ mode: "no-cors" เพื่อให้สามารถรับ response ได้
    })
    .then(response => {
      // แปลง response เป็น JSON
      return response.json();
    })
    .then(data => {
      console.log("Response from server:", data);
      
      if (data.result === 'success') {
        // แสดงสถานะการส่งสำเร็จ
        document.getElementById("sendStatus").innerHTML = `
          <div class="mb-4">
            <i class="fas fa-check-circle text-5xl text-green-500 mb-3"></i>
            <p class="text-lg">ส่งข้อมูลสำเร็จ!</p>
            <p class="text-gray-600">ข้อมูลถูกบันทึกใน Google Sheet เรียบร้อยแล้ว</p>
            <p class="text-gray-600">จำนวน ${data.appended} รายการ</p>
          </div>
        `;
      } else {
        // แสดงสถานะการส่งล้มเหลว
        document.getElementById("sendStatus").innerHTML = `
          <div class="mb-4">
            <i class="fas fa-exclamation-circle text-5xl text-red-500 mb-3"></i>
            <p class="text-lg">เกิดข้อผิดพลาด!</p>
            <p class="text-gray-600">${data.message || 'ไม่สามารถส่งข้อมูลได้ในขณะนี้'}</p>
          </div>
        `;
      }
      
      // ซ่อนปุ่มยืนยันการส่ง
      document.getElementById("confirmSend").style.display = "none";
    })
    .catch(err => {
      console.error("เกิดข้อผิดพลาด:", err);
      
      // แสดงสถานะการส่งล้มเหลว
      document.getElementById("sendStatus").innerHTML = `
        <div class="mb-4">
          <i class="fas fa-exclamation-circle text-5xl text-red-500 mb-3"></i>
          <p class="text-lg">เกิดข้อผิดพลาด!</p>
          <p class="text-gray-600">ไม่สามารถส่งข้อมูลได้ในขณะนี้: ${err.message}</p>
        </div>
      `;
      
      // ซ่อนปุ่มยืนยันการส่ง
      document.getElementById("confirmSend").style.display = "none";
    });
  };
  
  openModal('sendDataModal');
}

// วันที่
document.getElementById("date").addEventListener("input",(e)=>{
  document.getElementById("formattedDate").textContent="วันที่ที่เลือก: "+formatThaiDate(e.target.value);
});

// ค่าใช้จ่ายเพิ่มเติม - ปุ่มลด
document.querySelectorAll('#daily, #fuel, #food, #other').forEach((input, index) => {
  const buttons = input.parentElement.parentElement.querySelectorAll('button');
  const minusBtn = buttons[0];
  const plusBtn = buttons[1];
  
  // ปุ่มลด
  minusBtn.addEventListener('click', () => {
    const currentValue = parseInt(input.value) || 0;
    const newValue = Math.max(0, currentValue - 100);
    input.value = newValue;
    renderSummary();
  });
  
  // ปุ่มเพิ่ม
  plusBtn.addEventListener('click', () => {
    const currentValue = parseInt(input.value) || 0;
    const newValue = currentValue + 100;
    input.value = newValue;
    renderSummary();
  });
  
  // การพิมพ์โดยตรง
  input.addEventListener('input', () => {
    renderSummary();
  });
});

// ปิด modal เมื่อคลิกนอกพื้นที่ modal
window.onclick = function(event) {
  const calculateModal = document.getElementById("calculateModal");
  const resetModal = document.getElementById("resetModal");
  const sendDataModal = document.getElementById("sendDataModal");
  
  if (event.target == calculateModal) {
    calculateModal.style.display = "none";
  }
  if (event.target == resetModal) {
    resetModal.style.display = "none";
  }
  if (event.target == sendDataModal) {
    sendDataModal.style.display = "none";
  }
}

// ผูกปุ่มส่งข้อมูลกับฟังก์ชัน
document.getElementById("sendData").addEventListener("click", sendData);

// Render ครั้งแรก
renderTable();
</script>
</body>
</html>
