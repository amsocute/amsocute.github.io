<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>ЁЯУК р╕гр╕░р╕Ър╕Ър╕гр╕▓р╕вр╣Др╕Фр╣Йр╕Хр╕╣р╣Й</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 font-sans min-h-screen p-6">

<h1 class="text-3xl font-bold text-[#ff6b2c] mb-6 text-center">ЁЯУК р╕гр╕░р╕Ър╕Ър╕гр╕▓р╕вр╣Др╕Фр╣Йр╕Хр╕╣р╣Й</h1>

<!-- р╕зр╕▒р╕Щр╕Чр╕╡р╣И -->
<div class="mb-6 max-w-sm">
  <label class="block mb-2 font-semibold text-gray-700">ЁЯУЕ р╕зр╕▒р╕Щр╕Чр╕╡р╣И (р╕зр╕▒р╕Щ р╣Ар╕Фр╕╖р╕нр╕Щ р╕Ю.р╕и.)</label>
  <input type="date" id="dateInput" class="border-2 border-gray-300 rounded-lg p-2 w-full focus:outline-none focus:border-[#ff6b2c] text-lg">
  <p class="text-gray-600 mt-1" id="formattedDate"></p>
</div>

<!-- р╕Ыр╕╕р╣Ир╕б -->
<div class="mb-6 flex flex-wrap gap-3">
  <button id="addBranchBtn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-5 rounded-lg shadow">тЮХ р╣Ар╕Юр╕┤р╣Ир╕бр╕кр╕▓р╕Вр╕▓</button>
  <button id="resetBtn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-5 rounded-lg shadow">ЁЯФД р╕гр╕╡р╣Ар╕Лр╣Зр╕Хр╕Др╣Ир╕▓р╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щ</button>
  <button id="exportBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-5 rounded-lg shadow">ЁЯУЭ р╕нр╕нр╕Бр╕гр╕▓р╕вр╕Зр╕▓р╕Щ CSV</button>
</div>

<!-- р╕Хр╕▓р╕гр╕▓р╕Зр╕кр╕▓р╕Вр╕▓ -->
<div class="overflow-x-auto mb-8">
  <table class="w-full border text-sm bg-white rounded-xl shadow">
    <thead>
      <tr class="border-b bg-[#ff6b2c]/20">
        <th class="py-2 px-2 text-left">ЁЯПв р╕кр╕▓р╕Вр╕▓</th>
        <th class="py-2 px-2 text-left">ЁЯТ╡ р╕гр╕▓р╕вр╣Др╕Фр╣Й (THB)</th>
        <th class="py-2 px-2 text-left">ЁЯУК % р╣Ар╕Бр╣Зр╕Ъ</th>
        <th class="py-2 px-2 text-left text-red-500">ЁЯТ╕ р╕Др╣Ир╕▓р╣Гр╕Кр╣Йр╕Ир╣Ир╕▓р╕в</th>
        <th class="py-2 px-2 text-left text-green-600">ЁЯУИ р╕Бр╕│р╣Др╕г</th>
        <th class="py-2 px-2 text-left">ЁЯУН р╣Вр╕ер╣Ар╕Др╕Кр╕▒р╣Ир╕Щ</th>
        <th class="py-2 px-2 text-left">ЁЯЧСя╕П р╕ер╕Ъ</th>
      </tr>
    </thead>
    <tbody id="branchTableBody"></tbody>
  </table>
</div>

<!-- р╕Др╣Ир╕▓р╣Гр╕Кр╣Йр╕Ир╣Ир╕▓р╕вр╣Ар╕Юр╕┤р╣Ир╕бр╣Ар╕Хр╕┤р╕б -->
<div class="max-w-sm mb-8 bg-white p-4 rounded-xl shadow">
  <h2 class="text-lg font-semibold mb-3 text-gray-700">ЁЯЫТ р╕Др╣Ир╕▓р╣Гр╕Кр╣Йр╕Ир╣Ир╕▓р╕вр╣Ар╕Юр╕┤р╣Ир╕бр╣Ар╕Хр╕┤р╕б</h2>
  <div class="space-y-3">
    <div>
      <label class="block font-medium text-gray-600">ЁЯЧУя╕П р╕Др╣Ир╕▓р╣Гр╕Кр╣Йр╕Ир╣Ир╕▓р╕вр╕гр╕▓р╕вр╕зр╕▒р╕Щ</label>
      <input type="number" id="expenseDaily" placeholder="р╣Ар╕Кр╣Ир╕Щ 500" class="border rounded p-2 w-full focus:border-[#ff6b2c] focus:outline-none text-right">
    </div>
    <div>
      <label class="block font-medium text-gray-600">тЫ╜ р╕Др╣Ир╕▓р╕Щр╣Йр╕│р╕бр╕▒р╕Щ</label>
      <input type="number" id="expenseFuel" placeholder="р╣Ар╕Кр╣Ир╕Щ 1000" class="border rounded p-2 w-full focus:border-[#ff6b2c] focus:outline-none text-right">
    </div>
    <div>
      <label class="block font-medium text-gray-600">ЁЯНЬ р╕Др╣Ир╕▓р╕нр╕▓р╕лр╕▓р╕г</label>
      <input type="number" id="expenseFood" placeholder="р╣Ар╕Кр╣Ир╕Щ 800" class="border rounded p-2 w-full focus:border-[#ff6b2c] focus:outline-none text-right">
    </div>
    <div>
      <label class="block font-medium text-gray-600">ЁЯУж р╕нр╕╖р╣Ир╕Щ р╣Ж</label>
      <input type="number" id="expenseOther" placeholder="р╣Ар╕Кр╣Ир╕Щ 300" class="border rounded p-2 w-full focus:border-[#ff6b2c] focus:outline-none text-right">
    </div>
  </div>
</div>

<!-- р╕кр╕гр╕╕р╕Ы -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
  <div class="bg-[#ff6b2c]/10 p-5 rounded-xl shadow space-y-3 text-center">
    <p class="text-xl font-semibold text-gray-700">ЁЯТ╡ р╕гр╕зр╕бр╕гр╕▓р╕вр╣Др╕Фр╣Й: <span id="totalIncome">0</span> р╕Ър╕▓р╕Ч</p>
    <p class="text-xl font-semibold text-red-500">ЁЯТ╕ р╕Др╣Ир╕▓р╣Гр╕Кр╣Йр╕Ир╣Ир╕▓р╕вр╕кр╕▓р╕Вр╕▓ (<span id="avgPercent">0</span>%): <span id="totalBranchCost">0</span> р╕Ър╕▓р╕Ч</p>
    <p class="text-xl font-semibold text-green-600">ЁЯУИ р╕Бр╕│р╣Др╕гр╕кр╕▓р╕Вр╕▓: <span id="totalBranchProfit">0</span> р╕Ър╕▓р╕Ч</p>
  </div>
  <div class="bg-[#ff6b2c]/10 p-5 rounded-xl shadow space-y-3 text-center">
    <p class="text-xl font-semibold text-red-500">ЁЯЫТ р╕Др╣Ир╕▓р╣Гр╕Кр╣Йр╕Ир╣Ир╕▓р╕вр╣Ар╕Юр╕┤р╣Ир╕бр╣Ар╕Хр╕┤р╕б: <span id="totalExpenses">0</span> р╕Ър╕▓р╕Ч</p>
    <p class="text-2xl font-bold text-green-600">тЬЕ р╕Бр╕│р╣Др╕гр╕кр╕╕р╕Чр╕Шр╕┤: <span id="finalProfit">0</span> р╕Ър╕▓р╕Ч</p>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const INITIAL_BRANCHES = 10;
  let date = "";
  let branches = Array.from({ length: INITIAL_BRANCHES }, (_, i) => ({
    name: `р╕кр╕▓р╕Вр╕▓ ${i + 1}`,
    income: 0,
    percent: 30,
    location: "",
  }));
  let expenses = { daily:0, fuel:0, food:0, other:0 };
  const monthsTH = ["р╕бр╕Бр╕гр╕▓р╕Др╕б","р╕Бр╕╕р╕бр╕ар╕▓р╕Юр╕▒р╕Щр╕Шр╣М","р╕бр╕╡р╕Щр╕▓р╕Др╕б","р╣Ар╕бр╕йр╕▓р╕вр╕Щ","р╕Юр╕др╕йр╕ар╕▓р╕Др╕б","р╕бр╕┤р╕Цр╕╕р╕Щр╕▓р╕вр╕Щ","р╕Бр╕гр╕Бр╕Ор╕▓р╕Др╕б","р╕кр╕┤р╕Зр╕лр╕▓р╕Др╕б","р╕Бр╕▒р╕Щр╕вр╕▓р╕вр╕Щ","р╕Хр╕╕р╕ер╕▓р╕Др╕б","р╕Юр╕др╕ир╕Ир╕┤р╕Бр╕▓р╕вр╕Щ","р╕Шр╕▒р╕Щр╕зр╕▓р╕Др╕б"];

  function formatThaiDate(dateStr){
    if(!dateStr) return "";
    const [y,m,d] = dateStr.split("-").map(Number);
    return `${d} ${monthsTH[m-1]} ${y+543}`;
  }

  function render() {
    const table = document.getElementById("branchTableBody");
    table.innerHTML = "";
    let totalIncome = 0, totalBranchCost = 0, totalBranchProfit = 0;

    branches.forEach((b,i)=>{
      const cost = (b.income * b.percent)/100;
      const profit = b.income - cost;
      totalIncome += b.income;
      totalBranchCost += cost;
      totalBranchProfit += profit;

      const tr = document.createElement("tr");
      tr.className="border-b hover:bg-gray-50";
      tr.innerHTML = `
        <td class="py-1 px-2"><input type="text" value="${b.name}" data-index="${i}" data-field="name" class="w-full border rounded p-2 text-sm focus:border-[#ff6b2c] focus:outline-none"></td>
        <td class="py-1 px-2"><input type="number" value="${b.income}" data-index="${i}" data-field="income" class="w-full border rounded p-2 text-sm text-right focus:border-[#ff6b2c] focus:outline-none"></td>
        <td class="py-1 px-2"><input type="number" value="${b.percent}" data-index="${i}" data-field="percent" class="w-full border rounded p-2 text-sm text-center focus:border-[#ff6b2c] focus:outline-none" min="30" max="50"></td>
        <td class="py-1 px-2 text-red-500 font-bold text-right">${cost.toLocaleString()}</td>
        <td class="py-1 px-2 text-green-600 font-bold text-right">${profit.toLocaleString()}</td>
        <td class="py-1 px-2"><input type="text" value="${b.location}" data-index="${i}" data-field="location" class="w-full border rounded p-2 text-sm focus:border-[#ff6b2c] focus:outline-none"></td>
        <td class="py-1 px-2 text-center"><button data-index="${i}" class="removeBtn bg-red-500 hover:bg-red-600 text-white py-1 px-3 rounded text-xs">р╕ер╕Ъ</button></td>
      `;
      table.appendChild(tr);
    });

    document.getElementById("totalIncome").innerText = totalIncome.toLocaleString();
    document.getElementById("totalBranchCost").innerText = totalBranchCost.toLocaleString();
    document.getElementById("totalBranchProfit").innerText = totalBranchProfit.toLocaleString();
    document.getElementById("avgPercent").innerText = (branches.reduce((a,b)=>a+b.percent,0)/branches.length).toFixed(0);
    
    const totalExp = expenses.daily + expenses.fuel + expenses.food + expenses.other;
    document.getElementById("totalExpenses").innerText = totalExp.toLocaleString();
    document.getElementById("finalProfit").innerText = (totalBranchProfit - totalExp).toLocaleString();
  }

  // р╕зр╕▒р╕Щ
  document.getElementById("dateInput").addEventListener("input", (e)=>{
    date = e.target.value;
    document.getElementById("formattedDate").innerText = formatThaiDate(date);
  });

  // р╕Хр╕▓р╕гр╕▓р╕Зр╕кр╕▓р╕Вр╕▓ input
  document.getElementById("branchTableBody").addEventListener("input",(e)=>{
    const index = e.target.dataset.index;
    const field = e.target.dataset.field;
    let value = e.target.value;
    if(field==="income" || field==="percent") value = Number(value) || 0;
    branches[index][field] = value;
    render();
  });

  // р╕ер╕Ър╕кр╕▓р╕Вр╕▓
  document.getElementById("branchTableBody").addEventListener("click",(e)=>{
    if(e.target.classList.contains("removeBtn")){
      const index = e.target.dataset.index;
      branches.splice(index,1);
      render();
    }
  });

  // р╣Ар╕Юр╕┤р╣Ир╕бр╕кр╕▓р╕Вр╕▓
  document.getElementById("addBranchBtn").addEventListener("click",()=>{
    branches.push({name:`р╕кр╕▓р╕Вр╕▓ ${branches.length+1}`,income:0,percent:30,location:""});
    render();
  });

  // р╕гр╕╡р╣Ар╕Лр╣Зр╕Х
  document.getElementById("resetBtn").addEventListener("click",()=>{
    date = "";
    branches = Array.from({ length: INITIAL_BRANCHES }, (_, i) => ({
      name: `р╕кр╕▓р╕Вр╕▓ ${i + 1}`,
      income: 0,
      percent: 30,
      location: "",
    }));
    expenses = { daily:0, fuel:0, food:0, other:0 };
    document.getElementById("dateInput").value="";
    document.getElementById("formattedDate").innerText="";
    document.getElementById("expenseDaily").value="";
    document.getElementById("expenseFuel").value="";
    document.getElementById("expenseFood").value="";
    document.getElementById("expenseOther").value="";
    render();
  });

  // р╕Др╣Ир╕▓р╣Гр╕Кр╣Йр╕Ир╣Ир╕▓р╕вр╣Ар╕Юр╕┤р╣Ир╕бр╣Ар╕Хр╕┤р╕б
  ["Daily","Fuel","Food","Other"].forEach(key=>{
    document.getElementById("expense"+key).addEventListener("input",(e)=>{
      expenses[key.toLowerCase()] = Number(e.target.value) || 0;
      render();
    });
  });

  // export CSV
  document.getElementById("exportBtn").addEventListener("click",()=>{
    const header=["р╕зр╕▒р╕Щр╕Чр╕╡р╣И","р╕кр╕▓р╕Вр╕▓","р╕гр╕▓р╕вр╣Др╕Фр╣Й (р╕Ър╕▓р╕Ч)","% р╣Ар╕Бр╣Зр╕Ъ","р╕Др╣Ир╕▓р╣Гр╕Кр╣Йр╕Ир╣Ир╕▓р╕в (р╕Ър╕▓р╕Ч)","р╕Бр╕│р╣Др╕г (р╕Ър╕▓р╕Ч)","р╣Вр╕ер╣Ар╕Др╕Кр╕▒р╣Ир╕Щ"];
    const dateRow=[formatThaiDate(date),"","","","","",""];
    const rows = branches.map(b=>{
      const cost=(b.income*b.percent)/100;
      const profit=b.income-cost;
      return ["",b.name,b.income,b.percent,cost,profit,b.location];
    });
    const summary=[["","р╕гр╕зр╕бр╕гр╕▓р╕вр╣Др╕Фр╣Й",branches.reduce((a,b)=>a+b.income,0)],
                   ["","р╕Др╣Ир╕▓р╣Гр╕Кр╣Йр╕Ир╣Ир╕▓р╕вр╕кр╕▓р╕Вр╕▓",branches.reduce((a,b)=>a+(b.income*b.percent/100),0)],
                   ["","р╕Бр╕│р╣Др╕гр╕кр╕▓р╕Вр╕▓",branches.reduce((a,b)=>a+(b.income-(b.income*b.percent/100)),0)],
                   ["","р╕Др╣Ир╕▓р╣Гр╕Кр╣Йр╕Ир╣Ир╕▓р╕вр╣Ар╕Юр╕┤р╣Ир╕бр╣Ар╕Хр╕┤р╕б",expenses.daily+expenses.fuel+expenses.food+expenses.other],
                   ["","р╕Бр╕│р╣Др╕гр╕кр╕╕р╕Чр╕Шр╕┤",(branches.reduce((a,b)=>a+(b.income-(b.income*b.percent/100)),0)-(expenses.daily+expenses.fuel+expenses.food+expenses.other))]];
    const csvContent="\uFEFF"+[header,dateRow,...rows,[],...summary].map(r=>r.join(",")).join("\n");
    const blob=new Blob([csvContent],{type:"text/csv;charset=utf-8;"});
    const link=document.createElement("a");
    link.href=URL.createObjectURL(blob);
    link.setAttribute("download",`р╕гр╕▓р╕вр╕Зр╕▓р╕Щ_${date || "р╣Др╕бр╣Ир╕гр╕░р╕Ър╕╕р╕зр╕▒р╕Щр╕Чр╕╡р╣И"}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  });

  render();
});
</script>

</body>
</html>
